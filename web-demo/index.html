<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SVIT Helpdesk Bot 🎓</title>
<style>
:root{
  --bg:#e9eef5; --card:#fff; --muted:#6b7280; --primary:#007aff;
  --bot-bg:#e4f1ff; --user-bg:#cfe3ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);display:flex;justify-content:center;padding:22px;font-family:Inter,system-ui,Arial;height:100vh;}
.chat-wrap{width:100%;max-width:880px;height:calc(100vh - 44px);background:var(--card);border-radius:16px;display:flex;flex-direction:column;box-shadow:0 18px 40px rgba(9,30,66,0.08);overflow:hidden;}
.header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;background:linear-gradient(90deg,#0663d9,#0a9bff);color:#fff;border-radius:12px 12px 0 0;}
.header .title{font-weight:700;font-size:20px} .header small{display:block;font-weight:500;opacity:.92;font-size:13px}
.chat{flex:1;padding:20px;overflow:auto;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth;background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent);}
.msg {max-width:78%;padding:14px 16px;border-radius:14px;font-size:15px;line-height:1.45;box-shadow:0 8px 20px rgba(9,30,66,0.04);white-space:pre-wrap;}
.bot { background:var(--bot-bg); color:#02203c; align-self:flex-start; }
.user { background:var(--user-bg); color:#02203c; align-self:flex-end; }
.row { display:flex; gap:12px; align-items:flex-end; }
.right { justify-content:flex-end; }
.avatar{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;background:#fff;color:var(--primary);box-shadow:0 8px 20px rgba(9,30,66,0.05);flex-shrink:0;font-size:16px;}
.chips-wrap{position:sticky;bottom:86px;display:flex;justify-content:center;padding:12px 18px;z-index:40;}
.chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:100%;}
.chip{background:#eef6ff;border-radius:999px;padding:10px 18px;border:0;font-weight:700;color:#004a9f;cursor:pointer;opacity:0;transform:translateY(20px);box-shadow:0 8px 20px rgba(9,30,66,0.06);border:1px solid rgba(0,59,140,0.06)}
.chip.enter{ animation:chipIn .36s forwards; } @keyframes chipIn{ to{ opacity:1; transform:translateY(0); } }
.input-wrap{ padding:14px 20px;background:transparent;border-top:1px solid rgba(10,30,60,0.04) } 
.input{display:flex;gap:12px;background:#fff;border-radius:999px;padding:10px 12px;box-shadow:0 8px 28px rgba(9,30,66,0.06);align-items:center;}
.input input{ flex:1;border:0;outline:none;padding:12px 10px;border-radius:999px;font-size:15px;background:transparent }
.btn{ background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:700;box-shadow: 0 8px 18px rgba(2,100,255,0.12) }
.typing{ display:inline-flex;gap:6px;padding:10px;border-radius:12px;background:var(--bot-bg); }
.typing i{ width:8px;height:8px;border-radius:50%;background:#789; animation:pulse 1s infinite; } .typing i:nth-child(2){ animation-delay:.15s } .typing i:nth-child(3){ animation-delay:.3s } @keyframes pulse{ 50%{transform:translateY(-6px);opacity:.4} }
body.dark{ background:#061324 } body.dark .chat-wrap{ background:#071421 } body.dark .bot{ background:#0f2b3d;color:#e7f6ff } body.dark .user{ background:#064b7a;color:white } body.dark .chip{ background:#0b2d42;color:#bfe8ff;box-shadow:none }
@media(max-width:520px){ .header .title{font-size:18px} .chat{ padding:12px } .chip{ font-size:13px } }
a.bot-link{ color: #003a8c; font-weight:700; text-decoration: underline; }
.small-muted{ color:var(--muted); font-size:13px; margin-top:4px; }
</style>
</head>
<body>

<div class="chat-wrap" role="application" aria-label="SVIT Helpdesk">
  <div class="header">
    <div>
      <div class="title">SVIT Helpdesk Bot 🎓</div>
      <small>Ask about Admissions, Courses, Fees & More</small>
    </div>
    <div>
      <button id="themeBtn" title="Toggle theme" style="border-radius:50%;width:36px;height:36px;border:0;background:#fff;cursor:pointer">🌙</button>
    </div>
  </div>

  <div id="chat" class="chat" aria-live="polite"></div>

  <div class="chips-wrap">
    <div id="chips" class="chips"></div>
  </div>

  <div class="input-wrap">
    <div class="input">
      <input id="input" placeholder="Type a message or choose a suggestion..." aria-label="message input" />
      <button id="send" class="btn">Send</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const WEBHOOK = "https://svit-helpdesk-bot1.onrender.com/webhook"; // <-- change if your backend URL is different
const MAIN_CHIPS = ["Admissions","Courses","Fees","Events","Hostel","Transport","Library","Placement","Exams/Results","Contact"];
const COURSES = ["IT","CE","EC","Mechanical","Civil","Electrical","Aeronautical","MCA","M.Tech","⬅ Back to Main"];

/* ---------- STATE ---------- */
const chatEl = document.getElementById("chat");
const chipsEl = document.getElementById("chips");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const themeBtn = document.getElementById("themeBtn");
let dark = false;
let history = JSON.parse(localStorage.getItem("svit_history") || "[]");

/* ---------- helpers ---------- */
// creates DOM bubble; bot accepts HTML-safe string (we trust backend)
function createBubbleHTML(text, who="bot"){
  const wrapper = document.createElement("div");
  wrapper.className = "row " + (who==="bot" ? "left" : "right");
  const avatar = document.createElement("div"); avatar.className = "avatar";
  avatar.textContent = who==="bot" ? "SV" : "YOU";
  const msg = document.createElement("div"); msg.className = "msg " + (who==="bot" ? "bot" : "user");
  if(who === "bot"){
    // render HTML from backend (we only expect <b>, <br>, <a class="bot-link"...> )
    msg.innerHTML = text;
    // ensure links open in new tab when clicked (for some browsers)
    msg.querySelectorAll && msg.querySelectorAll('a').forEach(a => a.setAttribute('target','_blank'));
  } else {
    msg.innerText = text;
  }
  wrapper.appendChild(avatar); wrapper.appendChild(msg);
  return wrapper;
}

function renderMessage(text, who="bot"){
  const el = createBubbleHTML(text, who);
  chatEl.appendChild(el);
  chatEl.scrollTop = chatEl.scrollHeight;
  // persist minimal info (text as returned/rendered)
  history.push({who, text});
  localStorage.setItem("svit_history", JSON.stringify(history));
}

/* typing indicator */
function showTyping(on=true){
  if(on){
    if(document.getElementById("__typing")) return;
    const t = document.createElement("div");
    t.className="typing"; t.id="__typing";
    t.innerHTML = "<i></i><i></i><i></i>";
    const row = document.createElement("div"); row.className = "row left";
    const avatar = document.createElement("div"); avatar.className = "avatar"; avatar.textContent="SV";
    row.appendChild(avatar); row.appendChild(t);
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  } else {
    const el = document.getElementById("__typing");
    if(el) el.parentElement.remove();
  }
}

/* chips UI */
function showChips(list){
  chipsEl.innerHTML = "";
  list.forEach((c, i) => {
    const b = document.createElement("button");
    b.className = "chip";
    b.innerText = c;
    setTimeout(()=> b.classList.add("enter"), 30 + i*25);
    b.onclick = () => onChipClick(c);
    chipsEl.appendChild(b);
  });
}

/* chip behavior */
function onChipClick(label){
  if(label === "Courses"){
    renderMessage("Courses","user");
    renderMessage("🎓 <b>Courses Offered</b>: IT, CE, EC, Mechanical, Civil, Electrical, Aeronautical, MCA, M.Tech<br>👉 Select a department below","bot");
    showChips(COURSES);
    return;
  }
  if(label === "⬅ Back to Main"){
    renderMessage(label,"user");
    renderMessage("Main menu restored. Choose an option.","bot");
    showChips(MAIN_CHIPS);
    return;
  }
  // both course items and main chips call backend
  renderMessage(label,"user");
  callBackend(label);
}

/* call backend: fetch + typing */
async function callBackend(queryText){
  showTyping(true);
  await new Promise(r=>setTimeout(r, 350)); // natural pause
  try{
    const res = await fetch(WEBHOOK, {
      method: "POST",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query: queryText })
    });
    showTyping(false);
    if(!res.ok) throw new Error("network");
    const j = await res.json();
    // backend returns HTML-safe string for bot; convert newlines to <br> if any
    const replyRaw = j.reply || j.fulfillmentText || "Sorry, no info right now.";
    // convert plain newlines to <br> — but avoid double-encoding if reply already contains <br> or <a>
    const safeHtml = (replyRaw.indexOf("<") === -1) ? replyRaw.replace(/\n/g,"<br>") : replyRaw;
    renderMessage(safeHtml, "bot");

    // if queryText is a course branch, show back nav
    if(COURSES.includes(queryText)){
      showChips(["⬅ Back to Main"]);
    } else {
      showChips(MAIN_CHIPS);
    }
  }catch(e){
    showTyping(false);
    renderMessage("⚠ Network error. Make sure backend is running at " + WEBHOOK, "bot");
    showChips(MAIN_CHIPS);
  }
}

/* user input handlers */
sendBtn.addEventListener("click", onSend);
inputEl.addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ e.preventDefault(); onSend(); } });

function onSend(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = "";
  if(text.toLowerCase() === "courses" || text.toLowerCase() === "course"){
    renderMessage("Courses","user");
    renderMessage("🎓 <b>Courses Offered</b>: IT, CE, EC, Mechanical, Civil, Electrical, Aeronautical, MCA, M.Tech<br>👉 Select a department below","bot");
    showChips(COURSES);
    return;
  }
  renderMessage(text, "user");
  callBackend(text);
}

/* theme toggle */
themeBtn.addEventListener("click", ()=>{
  dark = !dark;
  document.body.classList.toggle("dark", dark);
  themeBtn.textContent = dark ? "☀️" : "🌙";
  localStorage.setItem("svit_theme", dark ? "dark":"light");
});
const savedTheme = localStorage.getItem("svit_theme");
if(savedTheme === "dark"){ dark = true; document.body.classList.add("dark"); themeBtn.textContent="☀️"; }

/* restore history */
function restoreHistory(){
  chatEl.innerHTML = "";
  history.forEach(msg => {
    const el = createBubbleHTML(msg.text, msg.who);
    chatEl.appendChild(el);
  });
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* init */
if(history.length === 0){
  renderMessage("👋 <b>Welcome</b> to SVIT Helpdesk — quick info & guided flow.","bot");
  renderMessage("✅ I can help with <b>Admissions, Courses, Fees, Events, Placement</b> and more. Use suggestions below or type your question.","bot");
  showChips(MAIN_CHIPS);
} else {
  restoreHistory();
  showChips(MAIN_CHIPS);
}
</script>
</body>
</html>
